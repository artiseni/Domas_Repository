{"version":3,"file":"index.modern.js","sources":["../src/services/PlatformCache.ts","../src/interceptors/PlatformCacheInterceptor.ts","../src/decorators/useCache.ts","../src/PlatformCacheModule.ts"],"sourcesContent":["import {isClass, isFunction} from \"@tsed/core\";\nimport {Configuration, Injectable} from \"@tsed/di\";\nimport {deserialize, JsonDeserializerOptions, serialize} from \"@tsed/json-mapper\";\nimport cacheManager, {Cache, CachingConfig, MultiCache, TtlFunction} from \"cache-manager\";\nimport micromatch from \"micromatch\";\nimport {PlatformCacheSettings} from \"../interfaces\";\n\nconst defaultKeyResolver = (args: any[]) => {\n  return args.map((arg: any) => (isClass(arg) ? JSON.stringify(serialize(arg)) : arg)).join(\":\");\n};\n\nexport type CacheManager = (Cache | MultiCache) & {\n  keys?(): Promise<string[]>;\n};\n\n/**\n * @platform\n */\n@Injectable()\nexport class PlatformCache {\n  @Configuration()\n  settings: Configuration;\n\n  cache: CacheManager | undefined;\n\n  disabled(): boolean {\n    return !this.settings.get<PlatformCacheSettings>(\"cache\");\n  }\n\n  $onInit() {\n    const settings = this.settings.get<PlatformCacheSettings>(\"cache\");\n\n    if (settings) {\n      const {caches, store = \"memory\", ttl, ...props} = settings;\n      // eslint-disable-next-line @typescript-eslint/no-unused-vars\n      this.cache = caches?.length\n        ? cacheManager.multiCaching(caches, {...props})\n        : cacheManager.caching({\n            ...props,\n            ttl,\n            store\n          });\n    }\n  }\n\n  defaultKeyResolver() {\n    return this.settings.get<(args: any[], ctx?: any) => string>(\"cache.keyResolver\", defaultKeyResolver);\n  }\n\n  defaultTtl() {\n    return this.settings.get<number | TtlFunction>(\"cache.ttl\");\n  }\n\n  ttl(result?: any, currentTtl?: number | TtlFunction) {\n    const ttl = currentTtl === undefined ? this.defaultTtl() : currentTtl;\n\n    return isFunction(ttl) ? ttl(result) : ttl;\n  }\n\n  wrap<T>(key: string, fetch: () => Promise<T>, options?: CachingConfig): Promise<T> {\n    if (!this.cache) {\n      return fetch();\n    }\n\n    return this.cache?.wrap<T>(key, fetch, options as any);\n  }\n\n  async get<T>(key: string, options: JsonDeserializerOptions = {}): Promise<T | undefined> {\n    return deserialize(this.cache?.get<T>(key), options);\n  }\n\n  async set<T>(key: string, value: any, options?: CachingConfig): Promise<T | undefined> {\n    return this.cache?.set<T>(key, value, options);\n  }\n\n  async del(key: string): Promise<void> {\n    await this.cache?.del(key);\n  }\n\n  async reset(): Promise<void> {\n    // @ts-ignore\n    await this.cache?.reset();\n  }\n\n  async keys(): Promise<string[]> {\n    if (this.cache?.keys) {\n      return this.cache.keys();\n    }\n    // istanbul ignore next\n    return [];\n  }\n\n  async getMatchingKeys(patterns: string): Promise<string[]> {\n    const keys = await this.keys();\n\n    return micromatch(keys, patterns);\n  }\n\n  async deleteMatchingKeys(patterns: string): Promise<string[]> {\n    const keys = await this.getMatchingKeys(patterns);\n\n    await Promise.all(keys.map((key: string) => this.del(key)));\n\n    return keys;\n  }\n}\n","import {isClass, isString, nameOf, Store} from \"@tsed/core\";\nimport {BaseContext, DIContext, Inject, Interceptor, InterceptorContext, InterceptorMethods, InterceptorNext} from \"@tsed/di\";\nimport {deserialize, serialize} from \"@tsed/json-mapper\";\nimport {JsonEntityStore} from \"@tsed/schema\";\nimport {IncomingMessage, ServerResponse} from \"http\";\nimport {PlatformCachedObject} from \"../interfaces/PlatformCachedObject\";\nimport {PlatformCacheOptions} from \"../interfaces/PlatformCacheOptions\";\nimport {PlatformCache} from \"../services/PlatformCache\";\n\nconst cleanHeaders = (headers: Record<string, unknown>) => {\n  return Object.entries(headers)\n    .filter(([key]) => ![\"content-length\", \"x-request-id\", \"cache-control\"].includes(key))\n    .reduce((headers, [key, value]) => {\n      return {\n        ...headers,\n        [key]: value\n      };\n    }, {});\n};\n\n/**\n * @platform\n */\n@Interceptor()\nexport class PlatformCacheInterceptor implements InterceptorMethods {\n  @Inject()\n  protected cache: PlatformCache;\n\n  async intercept(context: InterceptorContext<any, PlatformCacheOptions>, next: InterceptorNext) {\n    if (this.cache.disabled()) {\n      return next();\n    }\n\n    if (!this.isEndpoint(context)) {\n      return this.cacheMethod(context, next);\n    }\n\n    return this.cacheResponse(context, next);\n  }\n\n  protected getArgs(context: InterceptorContext<unknown, PlatformCacheOptions>) {\n    return context.args.reduce((args, arg) => {\n      if (arg instanceof DIContext || arg instanceof IncomingMessage || arg instanceof ServerResponse) {\n        return args;\n      }\n\n      if (isClass(arg)) {\n        return args.concat(serialize(arg));\n      }\n\n      return args.concat(arg);\n    }, []);\n  }\n\n  protected getOptions(context: InterceptorContext<any, PlatformCacheOptions>) {\n    const {ttl, type, collectionType, key: k = this.cache.defaultKeyResolver()} = context.options || {};\n\n    const args = this.getArgs(context);\n    const keyArgs = isString(k) ? k : k(args);\n\n    return {ttl, type, args, collectionType, keyArgs};\n  }\n\n  protected isEndpoint({target, propertyKey}: InterceptorContext<any, PlatformCacheOptions>) {\n    return Store.fromMethod(target, propertyKey).has(JsonEntityStore);\n  }\n\n  protected async cacheMethod(context: InterceptorContext<any, PlatformCacheOptions>, next: InterceptorNext) {\n    const {ttl, type, collectionType, keyArgs, args} = this.getOptions(context);\n    const key = [nameOf(context.target), context.propertyKey, keyArgs].join(\":\");\n\n    const cachedObject = await this.cache.get<PlatformCachedObject>(key);\n\n    if (cachedObject) {\n      const {data} = cachedObject;\n\n      return deserialize(JSON.parse(data), {collectionType, type});\n    }\n\n    const result = await next();\n    const calculatedTtl = this.cache.ttl(result, ttl);\n\n    await this.cache.set<PlatformCachedObject>(\n      key,\n      {\n        ttl: calculatedTtl,\n        args,\n        data: JSON.stringify(serialize(result, {type, collectionType}))\n      },\n      {\n        ttl: calculatedTtl\n      }\n    );\n\n    return result;\n  }\n\n  protected async cacheResponse(context: InterceptorContext<any, PlatformCacheOptions>, next: InterceptorNext) {\n    const $ctx: BaseContext = context.args[context.args.length - 1];\n    const {request, response} = $ctx;\n\n    if (request.method !== \"GET\") {\n      return next();\n    }\n\n    const {ttl, args, keyArgs} = this.getOptions(context);\n\n    const key = [request.method, request.url, keyArgs].join(\":\");\n\n    const cachedObject = await this.cache.get<PlatformCachedObject>(key);\n\n    if (cachedObject && !(response.get(\"cache-control\") === \"no-cache\")) {\n      return this.sendResponse(cachedObject, $ctx);\n    }\n\n    const result = await next();\n\n    const calculatedTtl = this.cache.ttl(result, ttl);\n    const expires = calculatedTtl + Date.now() / 1000;\n    $ctx.response.setHeaders({\n      \"cache-control\": `max-age=${calculatedTtl}`\n    });\n\n    // cache final response with his headers and body\n    response.onEnd(async () => {\n      const data = JSON.stringify(response.getBody());\n      const headers = cleanHeaders(response.getHeaders());\n\n      await this.cache.set<PlatformCachedObject>(\n        key,\n        {\n          ttl: calculatedTtl,\n          args,\n          data,\n          expires,\n          headers\n        },\n        {\n          ttl: calculatedTtl\n        }\n      );\n    });\n\n    return result;\n  }\n\n  protected sendResponse(cachedObject: PlatformCachedObject, $ctx: BaseContext) {\n    const {headers, ttl} = cachedObject;\n    const {request, response} = $ctx;\n\n    const requestEtag = request.get(\"if-none-match\");\n\n    if (requestEtag && headers.etag === requestEtag) {\n      response.status(304).setHeaders(headers).body(undefined);\n\n      return undefined;\n    }\n\n    const data = JSON.parse(cachedObject.data);\n\n    $ctx.response\n      .setHeaders({\n        ...headers,\n        \"x-cached\": \"true\",\n        \"cache-control\": `max-age=${ttl}`\n      })\n      .body(data);\n\n    return data;\n  }\n}\n","import {useDecorators} from \"@tsed/core\";\nimport {Intercept} from \"@tsed/di\";\nimport {PlatformCacheInterceptor} from \"../interceptors/PlatformCacheInterceptor\";\nimport {PlatformCacheOptions} from \"../interfaces/PlatformCacheOptions\";\n\nexport function UseCache(options: PlatformCacheOptions = {}) {\n  return useDecorators(Intercept(PlatformCacheInterceptor, options));\n}\n","import {Module} from \"@tsed/di\";\nimport {PlatformCache} from \"./services/PlatformCache\";\n\n/**\n * @ignore\n */\n@Module({\n  imports: [PlatformCache]\n})\nexport class PlatformCacheModule {}\n"],"names":["defaultKeyResolver","args","map","arg","isClass","JSON","stringify","serialize","join","PlatformCache","disabled","settings","get","$onInit","caches","store","ttl","props","cache","length","cacheManager","multiCaching","caching","defaultTtl","result","currentTtl","undefined","isFunction","wrap","key","fetch","options","deserialize","set","value","del","reset","keys","getMatchingKeys","patterns","micromatch","deleteMatchingKeys","Promise","all","__decorate","Configuration","Injectable","cleanHeaders","headers","Object","entries","filter","includes","reduce","PlatformCacheInterceptor","intercept","context","next","isEndpoint","cacheMethod","cacheResponse","getArgs","DIContext","IncomingMessage","ServerResponse","concat","getOptions","type","collectionType","k","keyArgs","isString","target","propertyKey","Store","fromMethod","has","JsonEntityStore","nameOf","cachedObject","data","parse","calculatedTtl","$ctx","request","response","method","url","sendResponse","expires","Date","now","setHeaders","onEnd","getBody","getHeaders","requestEtag","etag","status","body","Inject","Interceptor","UseCache","useDecorators","Intercept","PlatformCacheModule","Module","imports"],"mappings":"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"}